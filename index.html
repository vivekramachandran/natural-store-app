<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Barcode Scanner</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 0; 
    display: flex; 
    flex-direction: column; 
    align-items: center;
    background: #f5f5f5;
    padding: 20px;
  }
  
  h1 { 
    color: #333; 
    margin-bottom: 20px; 
  }
  
  #scanner-container {
    width: 90vw;
    max-width: 400px;
    height: 300px;
    position: relative;
    border: 3px solid #007bff;
    margin: 20px 0;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
  }

  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  #canvas {
    display: none;
  }
  
  #guide-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 10;
  }
  
  #guide-box {
    position: absolute;
    top: 40%; 
    left: 10%;
    right: 10%;
    height: 20%;
    border: 2px dashed #ff4444;
    background: rgba(255, 68, 68, 0.1);
    border-radius: 8px;
  }
  
  #guide-text {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    background: rgba(0, 0, 0, 0.7);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: bold;
  }
  
  #result {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    min-height: 40px;
    width: 90vw;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
  }
  
  .buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  button { 
    padding: 12px 20px; 
    cursor: pointer; 
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background: #007bff;
    color: white;
    transition: all 0.3s;
    font-weight: 600;
    min-width: 120px;
  }
  
  button:hover { 
    background: #0056b3; 
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
  }
  
  button:disabled { 
    background: #6c757d; 
    cursor: not-allowed; 
    transform: none;
    box-shadow: none;
  }
  
  #stopBtn { 
    background: #dc3545; 
  }
  #stopBtn:hover { 
    background: #c82333; 
    box-shadow: 0 4px 12px rgba(220,53,69,0.3);
  }
  
  .error { 
    color: #dc3545; 
    font-weight: bold;
  }
  .success { 
    color: #28a745; 
    font-weight: bold;
  }
  .info { 
    color: #007bff; 
    font-weight: bold;
  }
  
  .status {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 14px;
    max-width: 400px;
    text-align: center;
  }
  
  .detected-code {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 10px;
    margin: 10px 0;
    border-radius: 5px;
    border-left: 4px solid #28a745;
    font-size: 18px;
    font-weight: bold;
    word-break: break-all;
  }
  
  @media (max-width: 600px) {
    #scanner-container {
      width: 95vw;
      height: 250px;
    }
    #result {
      width: 95vw;
    }
    button {
      min-width: 100px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>

<h1>üì± Simple Barcode Scanner</h1>

<div class="status">
  Using jsQR library - Works with QR codes and some barcodes
</div>

<div id="scanner-container">
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas"></canvas>
  <div id="guide-overlay">
    <div id="guide-text">Align barcode/QR code here</div>
    <div id="guide-box"></div>
  </div>
</div>

<div id="result">
  Click "Start Scanner" to begin
</div>

<div class="buttons">
  <button id="startBtn" onclick="startScanner()">Start Scanner</button>
  <button id="stopBtn" onclick="stopScanner()" disabled>Stop Scanner</button>
</div>

<div class="status">
  üìù Note: This works best with QR codes. For traditional barcodes, try good lighting and steady hands!
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
<script>
let video = null;
let canvas = null;
let context = null;
let isScanning = false;
let animationId = null;

// Initialize elements
function initElements() {
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    context = canvas.getContext('2d');
}

// Start scanner
async function startScanner() {
    if (isScanning) return;
    
    initElements();
    
    document.getElementById('result').innerHTML = '<span class="info">üîç Requesting camera access...</span>';
    document.getElementById('startBtn').disabled = true;
    
    try {
        // Request camera access
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: 'environment', // Try back camera first
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });
        
        video.srcObject = stream;
        
        // Wait for video to load
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            isScanning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            document.getElementById('result').innerHTML = '<span class="info">üì± Scanning... point camera at barcode or QR code</span>';
            
            // Start scanning loop
            scanFrame();
        };
        
    } catch (err) {
        console.error('Camera error:', err);
        
        let errorMsg = '<span class="error">‚ùå Camera access failed<br><br>';
        
        if (err.name === 'NotAllowedError') {
            errorMsg += '<strong>Permission denied!</strong><br>' +
                       '‚Ä¢ Click the camera icon in address bar<br>' +
                       '‚Ä¢ Allow camera access<br>' +
                       '‚Ä¢ Refresh page and try again';
        } else if (err.name === 'NotFoundError') {
            errorMsg += '<strong>No camera found!</strong><br>' +
                       'Make sure your device has a working camera.';
        } else if (err.name === 'NotReadableError') {
            errorMsg += '<strong>Camera busy!</strong><br>' +
                       'Close other apps using the camera.';
        } else if (err.name === 'OverconstrainedError') {
            errorMsg += '<strong>Camera constraints not supported!</strong><br>' +
                       'Trying with different settings...';
            
            // Try again with basic constraints
            setTimeout(startScannerBasic, 1000);
            return;
        } else {
            errorMsg += '<strong>Error:</strong> ' + err.message;
        }
        
        errorMsg += '</span>';
        document.getElementById('result').innerHTML = errorMsg;
        document.getElementById('startBtn').disabled = false;
    }
}

// Fallback with basic camera constraints
async function startScannerBasic() {
    try {
        document.getElementById('result').innerHTML = '<span class="info">üîç Trying basic camera settings...</span>';
        
        const stream = await navigator.mediaDevices.getUserMedia({
            video: true // Just ask for any video
        });
        
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            isScanning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            document.getElementById('result').innerHTML = '<span class="info">üì± Scanning with front camera... point at barcode/QR code</span>';
            
            scanFrame();
        };
        
    } catch (err) {
        console.error('Basic camera failed:', err);
        document.getElementById('result').innerHTML = '<span class="error">‚ùå Unable to access any camera. Check browser permissions.</span>';
        document.getElementById('startBtn').disabled = false;
    }
}

// Main scanning loop
function scanFrame() {
    if (!isScanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // Draw video frame to canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Get image data
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        
        // Try to detect QR code
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
        });
        
        if (code) {
            onCodeDetected(code);
            return; // Stop scanning after detection
        }
    }
    
    // Continue scanning
    animationId = requestAnimationFrame(scanFrame);
}

// Handle code detection
function onCodeDetected(code) {
    console.log('Code detected:', code);
    
    // Play success beep
    playBeep();
    
    // Show result
    document.getElementById('result').innerHTML = `
        <span class="success">‚úÖ Code Detected!</span>
        <div class="detected-code">${code.data}</div>
        <small>Location: (${Math.round(code.location.topLeftCorner.x)}, ${Math.round(code.location.topLeftCorner.y)})</small>
    `;
    
    // Auto-stop after 3 seconds
    setTimeout(() => {
        stopScanner();
    }, 3000);
}

// Stop scanner
function stopScanner() {
    isScanning = false;
    
    // Stop animation loop
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    
    // Stop video stream
    if (video && video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
    }
    
    // Reset UI
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    
    if (document.getElementById('result').innerHTML.indexOf('Code Detected') === -1) {
        document.getElementById('result').innerHTML = 'Scanner stopped. Click "Start Scanner" to try again.';
    }
    
    console.log('Scanner stopped');
}

// Play success beep
function playBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000; // Higher pitch
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
        console.log('Beep not available');
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (isScanning) {
        stopScanner();
    }
});

// Test camera availability on load
window.addEventListener('load', async () => {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cameras = devices.filter(device => device.kind === 'videoinput');
        
        if (cameras.length === 0) {
            document.getElementById('result').innerHTML = '<span class="error">‚ùå No cameras detected on this device</span>';
            document.getElementById('startBtn').disabled = true;
        } else {
            console.log(`Found ${cameras.length} camera(s)`);
        }
    } catch (err) {
        console.log('Could not enumerate devices:', err);
    }
});

// Handle visibility change (pause when tab not active)
document.addEventListener('visibilitychange', () => {
    if (document.hidden && isScanning) {
        console.log('Tab hidden, pausing scanner');
    } else if (!document.hidden && isScanning) {
        console.log('Tab visible, resuming scanner');
    }
});
</script>

</body>
</html>
